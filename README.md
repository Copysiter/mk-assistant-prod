# FastAPI Skeleton

Проект представляет собой шаблон проектиролвания структуры приложения FastAPI, его интеграции с серверной частью Postgres и реализации простого процесса аутентификации по паролю OAuth2 с использованием веб-токенов Bearer и JSON (JWT).

## Быстрый старт
Запуск приложения осуществяляется тремя способами:

### 1. Запуск в виртуальном окружении.
```bash
$ python3 -m venv venv
$ source venv/bin/activate
$ pip install --upgrade pip && pip install -r requirements.txt --no-cache-dir
$ python main.py 
```
### 2. Запуск в Docker котейнере.
Создание образа:  
```bash
$ docker build . --tag <image_name>
```    
Запуск контеййнера:
```bash
$ docker run --rm --name <container_name> --publish <host_port>:<container_port> -v ./.env:/app/.env <image_name>
```
### 2. Запуск в котейнере через docker-compose.
```bash
$ docker compose up --build
```

## Структура приложения

```
project-root/
|-- migrations/
|   |-- versions/
|   |-- env.py
|-- src/
|   |-- api/
|   |   |-- v1/
|   |   |   |-- endpoints/
|   |   |   |   |-- api_router.py
|   |   |   |-- deps.py
|   |-- core/
|   |   |-- config.py
|   |   |-- logger.py
|   |   |-- security.py
|   |   |-- utils.py
|   |-- db/
|   |   |-- session.py
|   |   |-- init_db.py
|   |   |-- base_class.py
|   |-- middlewares/
|   |   |-- stats.py
|   |-- crud/
|   |   |-- __init__.py
|   |   |-- base.py
|   |   |-- item.py
|   |-- models/
|   |   |-- __init__.py
|   |   |-- item.py
|   |-- schemas/
|   |   |-- __init__.py
|   |   |-- item.py
|   |-- tests/
|   |-- utils/
|   |   |-- statsd/
|   |   |-- query_string.py
|-- .env
|-- .env.test
|-- .Dockerfile
|-- docker-compose.yml
|-- requirements.txt
|-- alembic.ini
|-- pytest.ini
|-- test.py
```

### 1. /migrations  
Папка `migrations` используется для управления миграциями базы данных с использованием Alembic. Alembic — инструмент для работы с миграциями схемы базы данных, позволяющий автоматизировать процесс изменения структуры базы данных со временем.

#### 1.1. /migrations/versions
Папка `versions` содержит файлы миграций для базы данных.

#### 1.2. /migrations/env.py
Файл `env.py` содержит конфигурацию окружения для Alembic. Этот файл определяет, как Alembic должен взаимодействовать с базой данных и какие параметры использовать для миграций. 

### 2. /src
Директория src (source) является основным источником кода проекта. Внутри этой директории располагаются модули, библиотеки, и другие компоненты, относящиеся к основной логике приложения.

#### 2.1. /src/api

##### <ins>/src/api/v1/endpoints</ins>
Папка `endpoints` содержит обработчики запросов для различных конечных точек API, например:
- `/src/api/v1/endpoints/item.py` - содержит обработчики запросов, связанные с сущностью `item`. Здесь определены функции для обработки HTTP-методов, таких как POST и GET, относящихся к сущности `item`.

Подробнее:  
https://fastapi.tiangolo.com/tutorial/first-steps/  

##### <ins>/src/api/v1/api_router.py</ins>
Модуль `api_router.py` объединяет все обработчики запросов в рамках версии API. В нем создается экземпляр класса APIRouter и добавляются к нему все роуты из папки `endpoints`

Подробнее:  
https://fastapi.tiangolo.com/reference/apirouter/?h=includ#fastapi.APIRouter.include_router

##### <ins>/src/api/v1/deps.py</ins>
Файл `deps.py` содержит зависимости (dependencies), которые могут быть использованы в обработчиках запросов для получения различных объектов, проверки данных или выполнения определенных действий. В общем случае, зависимости - это функции, выполняющиеся перед обработкой запроса.

Подробнее:  
https://fastapi.tiangolo.com/tutorial/dependencies/

#### 2.2. /src/core
Папка `core` содержит базовые компоненты, ответственные за общую функциональность и настройки приложения, такие как конфигурация, логирование, безопасность, и вспомогательные утилиты.

##### <ins>/src/core/config.py</ins>
Модуль `config.py` служит для обработки настроек приложения. В файле используется класс `BaseSettings` из библиотеки `Pydantic` для определения структуры настроек. Поддерживает загрузку из файла .env, что обеспечивает гибкость и безопасность управления конфигурацией.  

Подробнее:  
https://fastapi.tiangolo.com/advanced/settings/  
https://docs.pydantic.dev/latest/concepts/pydantic_settings/

##### <ins>/src/core/logger.py</ins>
Модуль `logger.py` отвечает за конфигурацию системы логирования в приложении. Здесь определены параметры, такие как уровень логирования, формат сообщений и настройки обработчиков логов.

##### <ins>/src/core/security.py<i/ns>
Модуль `security.py` содержит компоненты, связанные с обеспечением безопасности приложения. Это может включать функции аутентификации, авторизации и другие элементы, гарантирующие безопасность взаимодействия с приложением.

##### <ins>/src/core/utils.py</ins>
Модуль `utils.py` предоставляет вспомогательные функции и утилиты, которые могут быть использованы в различных частях проекта.

#### 2.3. /src/db
Директория `db` в проекте является ключевой частью, отвечающей за взаимодействие с базой данных. Внутри этой директории расположены модули, обеспечивающие создание сессий, инициализацию базы данных и определение базового класса для моделей данных.

##### <ins>/src/db/session.py</ins>
Модуль `session.py` содержит конфигурацию и создание асинхронных сессий для работы с базой данных.

Подробнее:
https://fastapi.tiangolo.com/tutorial/sql-databases/?h=session#create-a-sessionlocal-class
https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html#sqlalchemy.ext.asyncio.create_async_engine

##### <ins>/src/db/init_db.py</ins>
Модуль `init_db.py` содержит скрипт инициализации базы данных. В этом файле могут быть определены операции по созданию таблиц, индексов и других структур базы данных.

##### <ins>/src/db/base_class.py</ins>
Модуль `base_class.py` определяет базовый класс для моделей данных. Этот класс может содержать общие поля или методы, используемые во всех моделях приложения. В данной реализации определен метод метод, который генерирует и возвращает имя таблицы в базе данных. Использует регулярное выражение для преобразования имени класса из CamelCase в snake_case.

#### 2.4. /src/middlewares
Директория `middlewares` содержит компоненты пользовательское промежуточное ПО (Middleware), которые позволяют выполнять какие-либо операции до и после выполнения функции маршрута. Во Flask для этого используют функции before_request, after_request.

Подробнее:  
https://fastapi.tiangolo.com/tutorial/middleware/  
https://fastapi.tiangolo.com/advanced/middleware/

##### <ins>/src/middlewares/stats.py</ins>
Модуль `stats.py` содержит middleware, отвечающий за сбор и отслеживание статистики о запросах. Включает в себя подсчет времени обработки запроса, сбор информации о частоте вызовов различных эндпоинтов.

#### 2.5. /src/crud
Директория `crud` содержит модули, отвечающие за взаимодействие с базой данных в рамках операций CRUD (Create, Read, Update, Delete). Они предоставляют функции, которые выполняют соответствующие операции над моделями данных приложения. Это упрощает поддержку, обеспечивает переиспользование кода и повышает читаемость, так как каждый модуль предназначен для конкретной модели данных.

##### <ins>/src/crud/base.py</ins>
Модуль `base.py` содержит базовый класс для выполнения CRUD операций.

##### <ins>/src/crud/item.py</ins>
Модуль `item.py` содержит класс, наследуемый от базового, который содержит специфичные методы для конкретной модели данных (`item` в данном случае). Операции могут включать в себя создание, чтение, обновление и удаление объектов.

##### <ins>/src/crud/__init__.py</ins>
Файл `__init__.py` используется для группировки операций CRUD в общий модуль.

#### 2.6. /src/models
Директория `models` содержит определения моделей данных, хранящиеся в базе данных. Каждый файл в этой директории может содержать определение одной или нескольких моделей данных.

##### <ins>/src/models/item.py</ins>
Модуль `item.py` содержит определение модели данных Item (или другой сущности), которая будет храниться в базе данных.

##### <ins>/src/models/__init__.py</ins>
Файл `__init__.py` используется для группировки моделей данных в общий модуль.

#### 2.7. /src/schemas
Директория `schemas` содержит pydantic схемы данных, которые определяют формат входных и выходных данных для обработки запросов в вашем приложении. Схемы используются для валидации данных, автоматической генерации документации и других целей.

##### <ins>/src/schemas/item.py</ins>
Модуль `item.py` может содержать схемы данных, связанные с конкретной сущностью, например, схему `Item`. Эти схемы могут определять ожидаемую структуру данных для запроса и структуру данных ответа, например, при создании или обновлении объекта.

##### <ins>/src/schemas/__init__.py</ins>
Файл `__init__.py` используется для группировки схем данных в общий модуль.

#### 2.8. src/tests
Директория `tests` предназначена для хранения модулей тестов, проверяющих функциональность приложения.

##### <ins>/src/tests/api</ins>
Директория `api` содержит модули тестов, проверяющих работу API. Эти тесты включают в себя проверку статусов ответов, корректности данных и других аспектов API.

##### <ins>/src/tests/crud</ins>
Директория `crud` содержит модули тестов для проверки функций, связанных с операциями CRUD (Create, Read, Update, Delete).

##### <ins>/src/tests/unit</ins>
Директория `unit` содержит модули тестов, направленых на проверку отдельных функций, методов или классов, изолированных от внешних зависимостей.

##### <ins>/src/tests/conftest.py</ins>
Файл `conftest.py` используется для конфигурации тестового окружения. Здесь определяются фикстуры (fixtures) и другие настройки, необходимые для проведения тестов.

##### <ins>/src/tests/utils.py</ins>
Модуль `utils.py` содержит вспомогательные функции, которые могут быть использованы в различных тестах.

#### 2.9. /src/utils
Директория `utils` предназначена для хранения вспомогательных модулей, содержащих утилиты, которые могут быть использованы в различных частях приложения.

#### 2.10. /src/main.py
Модуль `main` представляет собой точку входа FastAPI и инициирует `app` объект (экземпляр FastAPI класса). Затем объект appпередается сервером при выполнении `uvicorn main:app` команды.

#### 3. /.env
Файл `.env` - это файл конфигурации, содержащий переменные окружения для проекта. В нем указаны такие настройки, как секретный ключ, параметры подключения к базе данных и другие переменные, которые могут различаться в зависимости от окружения.

#### 4. /.env.test
Файл   `.env.test` представляет собой аналогичный файл конфигурации для тестового окружения.

#### 5. /Dockerfile
Файл `Dockerfile` используется для создания Docker-образа приложения. В нем указаны инструкции для пошагового создания образа, включая базовый образ, установку зависимостей, копирование файлов проекта и запуск приложения.

#### 6. /docker-compose.yml
Файл `docker-compose.yml` используется для настройки сервисов, контейнеров и их взаимодействия в рамках Docker-композиции. Этот файл облегчает запуск и управление несколькими контейнерами Docker в рамках одного проекта.

#### 7. /requirements.txt
Файл `requirements.txt` содержит список зависимостей проекта. Включает в себя названия и версии библиотек, необходимых для работы приложения.

#### 8. /alembic.ini
Файл `alembic.ini` представляет собой конфигурационный файл для Alembic, инструмента для управления миграциями базы данных.

#### 9. /pytest.ini
Файл `pytest.ini` содержит конфигурацию для pytest, инструмента для написания и запуска тестов.

#### 10. /test.py
Файл `test.py` содержит код предназначенный для сборки Docker-образов, запуска контейнерв с приложеним и тестовой базой данных, а также автоматического выполнения тестов при помощи pytest. По завершении тестирования все созданные тестовые образы и контейнеры удаляются.

### Описание переменных окружения из `.env` файла
- `API_VERSION` - Версия API приложения.  
- `API_VERSION_PREFIX` - Префикс для маршрутов API, используемый для указания версии.  
- `PROJECT_NAME` - Название проекта FastAPI.  
- `PROJECT_HOST` и `PROJECT_PORT` - Хост и порт, на котором будет развернуто приложение.    
- `BACKEND_CORS_ORIGINS` - Настройка CORS (Cross-Origin Resource Sharing), указывающая разрешенные источники для запросов.
- `ASGI_WORKERS` - Количество воркеров Asgi сервера Uvicorn.
- `STATS_ENABLE` - Флаг, указывающий, включен ли сбор статистики.  
- `STATS_SERVER_HOST` и `STATS_SERVER_PORT` - Хост и порт сервера для сбора статистики.  
- `STATS_PREFIX` - Префикс для статистики, используемый при отправке метрик.  
- `STATS_BLOCK_URLS` - Список endpoint-в, запросы к которым будут игнорироваться при сборе статистики.  
- `POSTGRES_SERVER` и `POSTGRES_PORT` - Хост и порт сервера PostgreSQL.  
- `POSTGRES_USER` и `POSTGRES_PASSWORD` - Имя пользователя и пароль PostgreSQL.   
- `POSTGRES_DB` - Название базы данных PostgreSQL.  
- `POSTGRES_DSN` - Строка подключения к базе данных PostgreSQL в формате DSN (Data Source Name).  
- `DATABASE_DELETE_ALL` - Флаг, указывающий, удалять ли все данные из базы данных при каждом запуске приложения.  
- `DATABASE_CREATE_ALL` - Флаг, указывающий, создавать ли все необходимые таблицы при каждом запуске приложения.
- `DATABASE_POOL_SIZE` - Количество поддерживаемых соединений к базе данных, которое будет постоянно храниться в пуле.  
- `DATABASE_MAX_OVERFLOW` - Максимальный размер переполнения пула, установленного в pool_size.
- `FIRST_SUPERUSER` и `FIRST_SUPERUSER_PASSWORD` - Электронная почта и пароль первого пользователя приложения с root правами.    
- `EMAILS_ENABLED` - Флаг, указывающий, включена ли отправка электронных писем при регистрации.  
- `USERS_OPEN_REGISTRATION` - Флаг, указывающий, разрешена ли открытая регистрация пользователей. 
- `SECRET_KEY` - Секретный ключ приложения для подписи токенов при авторизации.
- `LOG_PATH` - Путь к фалу для записи логов. Если какая-либо директория в пути отсутствует - она создается автоматически.
- `LOG_FORMAT`, `LOG_LEVEL_DEFAULT`, `LOG_LEVEL_ACCESS`, `LOG_LEVEL_SQLALCHEMY` - формат и уровни логирования.